<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
  <header>
    <nav id="nav" class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" >Admin's Dashboard</a> 
          <div class="d-flex">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 ">
              <li class="nav-item">
                <a class="nav-link active" href="#info">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="#users">Users</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="#find">Search</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="#stats">Summary</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active " href="/login">Logout</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
  </header>
  <main id="container">
    <section id="info">
      <div id="panel">
        <div id="h2" class="row">
          <div class="col"><h2>Parking Lots</h2></div>
          <div class="col text-end"><a class="btn btn-primary"  href="#nav">Back</a></div>  
        </div>
    {% if msg %}
        {% if msg==1 %}
        <div class="alert alert-danger d-flex align-items-center mt-4" role="alert">
          <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Danger:"><use xlink:href="#exclamation-triangle-fill"/><symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
          </symbol></svg>
          <div>
            {{message}}
          </div>
        </div>
        {% elif msg==2 %}
      <div class="alert alert-success d-flex align-items-center mt-4" role="alert">
        <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:"><use xlink:href="#check-circle-fill"/><symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
          <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
        </symbol></svg>
        <div>
          {{message}}
        </div>
      </div>
      {% endif %}
    {% endif %}
        {%if lot%}
        <div id="a">
          {%for l in lot%}
            <div class="card" style="width: max(23%, 260px);" id="b">
              <div class="text-center">
                <input type="hidden" name="lot_id" value="{{l.id}}">
                <h5 class="card-title">{{l.name}}</h5>
                <a href="#" type="button" id="edit_button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editLot" data-val="{{l.id}}#{{l.name}}#{{l.price}}#{{l.address}}#{{l.pincode}}#{{l.t_spots}}#{{l.o_spots}}">Edit</a>
                <a href="#" type="button" id="delete_button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteLot" data-val="{{l.id}}#{{l.name}}#{{l.price}}#{{l.address}}#{{l.pincode}}#{{l.t_spots}}#{{l.o_spots}}">Delete</a>
                <div class="card-text">(Occupied : {{l.o_spots}})</div>
              </div>
              {%if l.spot%}
              <div class="card-body" class="d-flex">
                {%for spot in l.spot%}
                  {%if spot.status=="Available"%}
                  <a href="#" type="button" id="view_button" class="btn btn-success m-1" disabled>A</a>
                  {%else%}
                    {%for r in spot.reserve %}
                      {%if r.action == 1%}
                        <a href="#" type="button" id="view_button" class="btn btn-secondary m-1" data-bs-toggle="modal" data-bs-target="#viewSpot" data-val="{{spot.id}}#{{spot.status}}#{{r.uid}}#{{r.user.name}}#{{r.vehicle}}#{{r.parking_timestamp}}">O</a>
                      {%endif%} 
                    {%endfor%}
                  {%endif%}
                {%endfor%}
              </div>
              
                {%else%}
                <div class="text-center"><h6>No Parking Spots</h6></div>
                {%endif%}
            </div>
          {%endfor%}
        </div>
        {%else%}
        <div><h3>No Parking Lots are available!</h3></div>
        {%endif%}
        <div class="d-flex justify-content-md-center my-2">
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addLot">Add Lot</button>
        </div>       
      </div>
    </section>
    <section id="users">
        <div id="panel">
          <div id="h2" class="row">
            <div class="col"><h2>Users</h2></div>
            <div class="col text-end"><a class="btn btn-primary"  href="#nav">Back</a></div>  
        </div>            
        <div class="mt-4">
                <table class="table bg-light" border="5">
                    <thead>
                      <tr>
                        <th scope="col">Id</th>
                        <th scope="col">E-Mail</th>
                        <th scope="col">Full name</th>
                        <th scope="col">Address</th>
                        <th scope="col">Pincode</th>
                        <th scope="col">Phone No.</th>
                      </tr>
                    </thead>
                    <tbody>
                      {%for u in users%}
                      <tr>
                        <th scope="row">{{u.id}}</th>
                        <td>{{u.username}}</td>
                        <td>{{u.name}}</td>
                        <td>{{u.address}}</td>
                        <td>{{u.pincode}}</td>
                        <td>{{u.phone}}</td>
                      </tr>
                      {%endfor%}
                    </tbody>
                  </table>
            </div>
        </div>
    </section>
    <section id="find">
      <div id="panel">
          <div id="h2" class="row">
              <div class="col"><h2>Search</h2></div>
              <div class="col text-end"><a class="btn btn-primary" href="#nav">Back</a></div>  
          </div>
          <nav class="navbar navbar-light bg-light mb-4">
              <div class="container-fluid">
                <form class="d-flex" action="/search" method="post">
                  <select class="form-select" name="search_by">
                    <option value="0" selected>search by</option>
                    <option value="1">Users</option>
                    <option value="2">Parking Lots</option>
                 </select>
                  <input type="number" name="id" value=0 hidden>
                  <input type="number" name="role" value=0 hidden>
                  <input class="form-control me-2 ms-2" type="search" placeholder="Search" name="txt">
                  <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
              </div>
            </nav>
            {%if search_value%}
            {%if value==0%}
            <h5>Users</h5>
            <table class="table bg-light" border="5">
              <thead>
                <tr>
                  <th scope="col">Id</th>
                  <th scope="col">E-Mail</th>
                  <th scope="col">Full Name</th>
                  <th scope="col">Address</th>
                  <th scope="col">Pincode</th>
                  <th scope="col">Phone No.</th>
                  <th scope="col">Action</th>
                </tr>
              </thead>
              <tbody>
                {%for u in search_value%}
                <tr>
                  <th scope="row">{{u.id}}</th>
                  <td>{{u.username}}</td>
                  <td>{{u.name}}</td>
                  <td>{{u.address}}</td>
                  <td>{{u.pincode}}</td>
                  <td>{{u.phone }}</td>
                  <td>
                    <a href="#" type="button" id="view_button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#history{{u.id}}" >User History</a>
<!---------------------------------------------view user history---------------------->                    
                    <div class="modal fade" id="history{{u.id}}" tabindex="-1" >
                      <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">User History</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            {%if u.reserve %}
                            <table class="table bg-light mt-4" border="5">
                              <thead>
                                <tr>
                                  <th scope="col">Id</th>
                                  <th scope="col">Prime Location Name</th>
                                  <th scope="col">Vehicle no.</th>
                                  <th scope="col">Parking time</th>
                                  <th scope="col">Leaving time</th>
                                  <th scope="col">Status</th>
                                  <th scope="col">Cost</th>
                                  <th scope="col">Payment</th>
                                </tr>
                              </thead>
                              <tbody>
                                {%for r in u.reserve%}
                                <tr>
                                  <th scope="row">{{r.id}}</th>
                                  <td >{{r.spot.lot.name}}</td>
                                  <td>{{r.vehicle}}</td>
                                  <td>{{r.parking_timestamp}}</td>
                                  <td>{{r.leaving_timestamp}}</td>
                                  <td class="text-primary">{{r.status}}</td>
                                  <td>{{r.cost}}</td>
                                  {% if r.action == 1 %}
                                  <td></td>
                                  {% elif r.action == 2 %}
                                  <td class="text-danger">pending</td>
                                  {% else %} <td class="text-success">Paid</td> {% endif %}
                                </tr>
                                {%endfor%}
                              </tbody>
                            </table>
                            {%else%} <div class="text-center">No History</div> {%endif%}
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                {%endfor%}
              </tbody>
            </table>
            {%else%}
            <div id="a">
          {%for l in search_value%}
            <div class="card" style="width: max(23%, 260px);" id="b">
              <div class="text-center">
                <input type="hidden" name="lot_id" value="{{l.id}}">
                <h5 class="card-title">{{l.name}}</h5>
                <a href="#" type="button" id="edit_button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editLot" data-val="{{l.id}}#{{l.name}}#{{l.price}}#{{l.address}}#{{l.pincode}}#{{l.t_spots}}#{{l.o_spots}}">Edit</a>
                <a href="#" type="button" id="delete_button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteLot" data-val="{{l.id}}#{{l.name}}#{{l.price}}#{{l.address}}#{{l.pincode}}#{{l.t_spots}}#{{l.o_spots}}">Delete</a>
                <div class="card-text">(Occupied : {{l.o_spots}})</div>
              </div>
              {%if l.spot%}
              <div class="card-body" class="d-flex">
                {%for spot in l.spot%}
                  {%if spot.status=="Available"%}
                  <a href="#" type="button" id="view_button" class="btn btn-success m-1" data-bs-toggle="modal" data-bs-target="#history{{spot.id}}">A</a>                  
                    {%else%}
                    {%for r in spot.reserve %}
                      {%if r.action == 1%}
                        <a href="#" type="button" id="view_button" class="btn btn-secondary m-1" data-bs-toggle="modal" data-bs-target="#history{{spot.id}}">O</a>
                      {%endif%} 
                    {%endfor%}
                  {%endif%}
<!---------------------------------------------view spot history---------------------->                    
                    <div class="modal fade" id="history{{spot.id}}" tabindex="-1" >
                      <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Spot History</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            {%if spot.reserve %}
                            <table class="table bg-light mt-4" border="5">
                              <thead>
                                <tr>
                                  <th scope="col">Id</th>
                                  <th scope="col">User Name</th>
                                  <th scope="col">Vehicle no.</th>
                                  <th scope="col">Parking time</th>
                                  <th scope="col">Leaving time</th>
                                  <th scope="col">Status</th>
                                  <th scope="col">Cost</th>
                                  <th scope="col">Payment</th>
                                </tr>
                              </thead>
                              <tbody>
                                {%for r in spot.reserve%}
                                <tr>
                                  <th scope="row">{{r.id}}</th>
                                  <td >{{r.user.name}}</td>
                                  <td>{{r.vehicle}}</td>
                                  <td>{{r.parking_timestamp}}</td>
                                  <td>{{r.leaving_timestamp}}</td>
                                  <td class="text-primary">{{r.status}}</td>
                                  <td>{{r.cost}}</td>
                                  {% if r.action == 1 %}
                                  <td></td>
                                  {% elif r.action == 2 %}
                                  <td class="text-danger">pending</td>
                                  {% else %} <td class="text-success">Paid</td> {% endif %}
                                </tr>
                                {%endfor%}
                              </tbody>
                            </table>
                            {%else%} <div class="text-center">No History</div> {%endif%}
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>                
                    {%endfor%}
              </div>
              
                {%else%}
                <div class="text-center"><h6>No Parking Spots</h6></div>
                {%endif%}
            </div>
          {%endfor%}
        </div>
            {%endif%}
            {%else%}
            <h5 class="text-center">No Results</h5>
          {%endif%}
      </div>
  </section>
    <section id="stats">
        <div id="panel">
            <div id="h2" class="row">
                <div class="col"><h2>Statistics</h2></div>
                <div class="col text-end"><a class="btn btn-primary" href="#nav">Back</a></div>  
            </div>
            <div class="row d-flex">
              <div class="col my-4" >
                <img src="../static/spot.png" alt="spot">
              </div>
              <div class="col my-4" >
                <img src="../static/revenue.png" alt="revenue">
              </div>
            </div>
            
        </div>
    </section>
    <!--Add Lots Modal-->
    <form class="d-flex" action="/lotadd" method="post">  
      <div class="modal fade" id="addLot" tabindex="-1" >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add Lot</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <label for="name" class="form-label">Prime Location Name</label>
              <input type="text" class="form-control" name="name" id="name" required>
              <label for="address" class="form-label">Address</label>
              <textarea class="form-control" name="address" id="address" rows="2" required></textarea>
              <label for="pincode" class="form-label">Pincode</label>
              <input type="number" maxlength="6" placeholder="Enter exactly 6 digits" class="form-control" name="pincode" id="pincode" required>
              <label for="price" class="form-label">Price(per hour)</label>
              <input type="number" class="form-control" name="price" id="price" required>
              <label for="t_spots" class="form-label">Maximum Spots</label>
              <input type="number" value="0" class="form-control" name="t_spots" id="t_spots" required>
              <label for="o_spots" class="form-label" hidden>Occupied Spots</label>
              <input type="number" value="0" class="form-control" name="o_spots" id="o_spots" hidden>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Add</button>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!--Edit Lots Modal-->
    <form class="d-flex" action="/lotedit" method="post">  
      <div class="modal fade" id="editLot" tabindex="-1" >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Edit Lot</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="number" id="lot_id" name="lot_id" hidden>
              <label for="name" class="form-label">Prime Location Name</label>
              <input type="text" class="form-control" name="name" id="name" required>
              <label for="address" class="form-label">Address</label>
              <textarea class="form-control" name="address" id="address" rows="2" required></textarea>
              <label for="pincode" class="form-label">Pincode</label>
              <input type="number" maxlength="6" placeholder="Enter exactly 6 digits" class="form-control" name="pincode" id="pincode" required>
              <label for="price" class="form-label">Price(per hour)</label>
              <input type="number" class="form-control" name="price" id="price" required>
              <label for="t_spots" class="form-label">Total Spots</label>
              <input type="number" class="form-control" name="t_spots" id="t_spots" required>
              <label for="o_spots" class="form-label">Occupied Spots</label>
              <input type="number" class="form-control" name="o_spots" id="o_spots" readonly>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Update</button>
            </div>
          </div>
        </div>
      </div>
    </form>
    <script>
      $("#editLot").on("show.bs.modal", function(event){
        var st=$(event.relatedTarget).data('val');
        var values=st.split('#');
        $(this).find('#lot_id').val(values[0]);
        $(this).find('#name').val(values[1]);
        $(this).find('#price').val(values[2]);
        $(this).find('#address').val(values[3]);
        $(this).find('#pincode').val(values[4]);
        $(this).find('#t_spots').val(values[5]);
        $(this).find('#o_spots').val(values[6]);
          });
    </script>

    <!--Delete Lots Modal-->
    <form class="d-flex" action="/lotdelete" method="post">  
      <div class="modal fade" id="deleteLot" tabindex="-1" >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Delete Lot</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="number" id="lot_id" name="lot_id" hidden>
              <label for="name" class="form-label">Prime Location Name</label>
              <input type="text" class="form-control" name="name" id="name" readonly>
              <label for="address" class="form-label">Address</label>
              <textarea class="form-control" name="address" id="address" rows="2" readonly></textarea>
              <label for="pincode" class="form-label">Pincode</label>
              <input type="number" class="form-control" name="pincode" id="pincode" readonly>
              <label for="price" class="form-label">Price(per hour)</label>
              <input type="number" class="form-control" name="price" id="price" readonly>
              <label for="t_spots" class="form-label">Total Spots</label>
              <input type="number" class="form-control" name="t_spots" id="t_spots" readonly>
              <label for="o_spots" class="form-label">Occupied Spots</label>
              <input type="number" class="form-control" name="o_spots" id="o_spots" readonly>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Delete</button>
            </div>
          </div>
        </div>
      </div>
    </form>
    <script>
      $("#deleteLot").on("show.bs.modal", function(event){
        var st=$(event.relatedTarget).data('val');
        var values=st.split('#');
        $(this).find('#lot_id').val(values[0]);
        $(this).find('#name').val(values[1]);
        $(this).find('#price').val(values[2]);
        $(this).find('#address').val(values[3]);
        $(this).find('#pincode').val(values[4]);
        $(this).find('#t_spots').val(values[5]);
        $(this).find('#o_spots').val(values[6]);
          });
    </script>
<!-------------View Spot---------------------->
  <div class="modal fade" id="viewSpot" tabindex="-1" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">View Spot</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label for="sid" class="form-label">Spot Id</label>
          <input type="text" class="form-control" name="sid" id="sid" readonly>
          <label for="status" class="form-label">Status</label>
          <input type="text" class="form-control" name="status" id="status" readonly>
          <label for="uid" class="form-label">User Id</label>
          <input type="text" class="form-control" name="uid" id="uid" readonly> 
          <label for="uname" class="form-label">User Name</label>
          <input type="text" class="form-control" name="uname" id="uname" readonly>          
          <label for="vehicle" class="form-label">Vehicle No.</label>
          <input type="text" class="form-control" name="vehicle" id="vehicle" readonly>
          <label for="ptime" class="form-label">Parking time</label>
          <input type="text" class="form-control" name="ptime" id="ptime" readonly> 
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
<script>
  $("#viewSpot").on("show.bs.modal", function(event){
    var st=$(event.relatedTarget).data('val');
    var values=st.split('#');
    $(this).find('#sid').val(values[0]);
    $(this).find('#status').val(values[1]);
    $(this).find('#uid').val(values[2]);
    $(this).find('#uname').val(values[3]);
    $(this).find('#vehicle').val(values[4]);
    $(this).find('#ptime').val(values[5]);
  });
</script>
  </main>
  <footer></footer>
</body>
</html>